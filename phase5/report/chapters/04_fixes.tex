\chapter{Fixes}\label{chapter:fixes}

For each vulnerability discovered in Phase 4 by your team or the team that tested your
application, you should summarize the fix (security measure) that you implemented:
\begin{itemize}
	\item Path(s) of file(s) which were modified for the fix
	\item Line number(s) which were modified in each file 
	\item NOTE: You can use a diff utility but you should only report the changes relevant for one particular fix per vulnerability (not just a diff of all changes to phase 3).
	\item Textual description of your countermeasures and why it fixes the problem (i.e. the effect that the modifications have against attack).
\end{itemize}

Sample table
\fixtable{%
	%Description of the vulnerability
}{%
	%Cvss score
}{%
	%Countermeasures (description)
}{%
	%Modified files (paths)
}{%
	%Modified line numbers
}

\section{Configuration and Deploy Management Testing}
\simpleVulntitle{OTG-CONFIG-001}{Test File Extensions Handling for Sensitive Information}
\fixtable{%
	When performing batch transactions, the transaction file uploaded by the
	user was accessible by everyone who could guess the filename until the
	transaction was processed.
}{%
	\cvssBaseScorePretty{N}{H}{N}{R}{U}{L}{N}{N}
}{%
	To prevent attackers from accessing sensitive information we now prevent
	all access to the lib and tmp folders by denying access to them in the
	apache2 site configuration.
	PHP files that shouldn't be accessed directly by the user are now located
	in the lib folder.
	The newly created tmp folder now contains the previously mentioned uploads
	folder for temporary batch transaction files and the holder folder for
	temporary password protected tan lists of new users.
	Additionally we now display the same error page for "not found (404)" and
	"permission denied (403)" errors to prevent disclosing the internal folder
	structure.
}{%
	/config/apache2/site-available/gnb \newline
	/project/resource\_mappings.php \newline
	Moved files/directories:
	\begin{itemize}
		\item /project/uploads/ -> /project/tmp/uploads/
		\item /project/holder/ -> /project/tmp/holder/
		\item /project/gnbmailer.php -> /project/lib/gnbmailer/gnbmailer.php
		\item /project/templates/ -> /project/lib/gnbmailer/templates/
	\end{itemize}
}{%
	Added/changed lines 21-34 in the apache2 site configuration \texttt{gnb} \newline
	Updated lines 33,34,56,63,64 in the resource\_mappings.php to reflect the changed paths
}


\clearpage
\section{Identity Management Testing}
\simpleVulntitle{OTG-IDENT-002}{Test User Registration Process}
\fixtable{%
	The registration process was available to anyone, allowing to register countless users as long as a valid email was provided. Although a user would need to be manually approved by an employee of the bank, it was possible to generate DOS attacks by creating robot accounts (or at least saturating the database with dummy data).
}{%
	\cvssBaseScorePretty{N}{L}{N}{N}{U}{N}{N}{L}
}{%
	To prevent attackers to register countless users using automated scripts we added a CAPTCHA functionality.
}{%
	/project/registration/registration.php, /project/registration/registration\_request.php
}{%
	Added lines 13, 96-106 inside \texttt{registration.php}, and added lines 25, 35, 56-61 inside \texttt{registration\_request.php}.
}


\clearpage
\vulntitle{OTG-IDENT-003}{Test Account Provisioning Process}
\fixtable{%
	Provisioning clients is an easy process with no effective mechanisms to verify or vet clients besides a manual approval process, provisioning employees is set up in a similar matter.
}{%
	\cvssBaseScorePretty{N}{L}{N}{N}{U}{N}{N}{L}
}{%
	Only employees/admins are allowed to approve or reject user registrations. Since this application is only web-based and cannot provide any out of bound verification (e.g. the personal ID of a client, his tax code or similar), we must presume this can only happen physically at the Bank. Also the assumption is that users (both clients and employees) will only be approved by employees after a meeting in person at the bank, during which an employee has verified the personal data of said user.\newline
	Given this argument, we decided to treat the account provisioning process as secure.
}{%
	None
}{%
	\na
}


\clearpage
\section{Error Handling}
\simpleVulntitle{OTG-ERR-001}{Analysis of Error Codes}
\fixtable{%
	When uploading a batch file containing format errors the application would return an error code instead of an error message.
}{%
	\cvssBaseScorePretty{P}{L}{L}{R}{U}{L}{N}{N}
}{%
	The vulnerability was due to the application displaying all messages returned from the C parser to the client. We simply changed the output of the parser to display a custom error, containing the line of the batch file in which the error occurred, instead of an error code.
}{%
	/project/lib/ctransact/src/ctransact.c
}{%
	Modified line 65 inside \texttt{ctransact.c}
}


\clearpage
\section{Cryptography}
\simpleVulntitle{OTG-CRYPST-001}{Testing for Weak SSL/TSL Ciphers, Insufficient Transport Layer Protection}


\clearpage
\section{Business Logic Testing}
\simpleVulntitle{OTG-BUSLOG-001}{Test Business Logic Data Validation}
\vulntitle{OTG-BUSLOG-006}{Testing for the Circumvention of Work Flows}
\fixtable{%
	The application was generating plain error messages upon a login attempt with an empty password field, preventing the user from returning to the login page via graphical means, and providing some insight about the application's error handling policy.
}{%
	\cvssBaseScorePretty{N}{L}{L}{R}{U}{N}{N}{L}
}{%
	The \gnb{} application returns custom error messages when submitting forms with user input. As of phase 3, user input was sanitized using a custom \texttt{sanitize\_input} function. This function would simply exit, returning a generic error message (without html formatting), in case an input wasn't sanitized correctly. This was due to a faulty error message handling, which was later on discovered on other pages as well.
	We modified the input sanitization function (the \texttt{check\_post\_input} function was also added) to return a value in case an input wasn't sanitized correctly (instead of exiting). This allowed to generate more specific errors, depending on the page. Furthermore, by slightly changing the input checks inside other pages, we implemented a simpler logic for displaying error messages. \newline
	For uniformity in error reporting, we applied minor changes to the following files as well: \texttt{new\_transaction.php, verify\_transaction.php, new\_transaction\_multiple.php, registration.php, registration\_request.php}.
}{%
	/project/genericfunctions.php, /project/authentication.php, /project/login.php
}{%
	Added lines 10-15 inside \texttt{genericfunctions.php} and accordingly edited lines 15-21 inside \texttt{authentication.php}, as well as lines 60-69 inside \texttt{login.php}.
}


\vulntitle{OTG-BUSLOG-007}{Test Defenses Against Application Mis-use}
