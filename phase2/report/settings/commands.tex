% Basic information for cover & title page
\newcommand*{\getUniversity}{Technische Universität München}
\newcommand*{\getFaculty}{Department of Informatics}
\newcommand*{\getTitle}{Blackbox Testing Report}
\newcommand*{\getAuthor}{%
	Team 12\\
	Alexander Lill\\
	Lorenzo Donini\\
	Florian Mauracher\\
	Mahmoud Naser\\
}
\newcommand*{\getDoctype}{Secure Coding - Phase 2}
\newcommand*{\doge}{DogeBank}
\newcommand*{\gnb}{Goliath National Bank}

\newcommand*{\vulntitle}[2]{%
	\subsection{#2 (#1)}\label{vuln:#1}
}
\newcommand{\vultable}[6]{%
	\begin{table}[htpb]
		\centering
		\begin{tabularx}{\textwidth}{l | X}
			\toprule
			& #1 \\
			\midrule
			\textbf{Observation} & #2 \\
			\textbf{Discovery} & #3 \\
			\textbf{Likelihood} & #4 \\
			\textbf{Implication} & #5 \\
			\textbf{CVSS} & #6 \\
			\bottomrule
		\end{tabularx}
	\end{table}
}

% Levels from https://www.first.org/cvss/specification-document#i8.4

%1 Attack Vector
%Network N, Adjacent A, Local L, Physical P
\newcommand*{\AVNvalue}{0.85}
\newcommand*{\AVAvalue}{0.62}
\newcommand*{\AVLvalue}{0.55}
\newcommand*{\AVPvalue}{0.2}
\newcommand{\parseAttackVector}[1]{%
  \ifnum\pdfstrcmp{#1}{N}=0
	\AVNvalue%
  \else\ifnum\pdfstrcmp{#1}{A}=0
    \AVAvalue%
  \else\ifnum\pdfstrcmp{#1}{L}=0
    \AVLvalue%
  \else\ifnum\pdfstrcmp{#1}{P}=0
    \AVPvalue%
  \else
    InvalidAttackVector%
  \fi\fi\fi\fi%
}

%2 Attack Complexity
%Low L, High H
\newcommand*{\ACLvalue}{0.77}
\newcommand*{\ACHvalue}{0.44}
\newcommand{\parseAttackComplexity}[1]{%
  \ifnum\pdfstrcmp{#1}{L}=0
	\ACLvalue%
  \else\ifnum\pdfstrcmp{#1}{H}=0
    \ACHvalue%
  \else
    InvalidAttackComplexity%
  \fi\fi%
}

%3 Privileges Required
%None N, Low L, High H
\newcommand*{\PRNvalue}{0.85}
\newcommand*{\PRLvalue}{0.62}
\newcommand*{\PRLSCvalue}{0.68}
\newcommand*{\PRHvalue}{0.27}
\newcommand*{\PRHSCvalue}{0.50}
\newcommand{\parsePrivilegesRequired}[2]{%
	% #1 = Privileges Required
	% #2 = Scope
  \ifnum\pdfstrcmp{#2}{U}=0
	\parsePrivilegesRequiredScopeUnchanged{#1}%
  \else\ifnum\pdfstrcmp{#2}{C}=0
    \parsePrivilegesRequiredScopeChanged{#1}%
  \else
    InvalidPrivilegesRequired%
  \fi\fi%
}

\newcommand{\parsePrivilegesRequiredScopeUnchanged}[1]{%
  \ifnum\pdfstrcmp{#1}{N}=0
	\PRNvalue%
  \else\ifnum\pdfstrcmp{#1}{L}=0
    \PRLvalue%
  \else\ifnum\pdfstrcmp{#1}{H}=0
    \PRHvalue%
  \else
    InvalidPrivilegesRequiredScopeUnchanged%
  \fi\fi\fi%
}

\newcommand{\parsePrivilegesRequiredScopeChanged}[1]{%
  \ifnum\pdfstrcmp{#1}{N}=0
	\PRNvalue%
  \else\ifnum\pdfstrcmp{#1}{L}=0
    \PRLSCvalue%
  \else\ifnum\pdfstrcmp{#1}{H}=0
    \PRHSCvalue%
  \else
    InvalidPrivilegesRequiredScopeChanged%
  \fi\fi\fi%
}

%4 User Interaction
%None N, Required R
\newcommand*{\UINvalue}{0.85}
\newcommand*{\UIRvalue}{0.62}
\newcommand{\parseUserInteraction}[1]{%
  \ifnum\pdfstrcmp{#1}{N}=0
	\UINvalue%
  \else\ifnum\pdfstrcmp{#1}{R}=0
    \UIRvalue%
  \else
    InvalidAttackVector%
  \fi\fi%
}

%5 Scope
%Unchanged U, Changed C
% SEE parsePrivilegesRequired

%6 Confidentiality Impact
%High H, Low L, None N
%7 Integrity Impact
%High H, Low L, None N
%8 Availability Impact
%High H, Low L, None N
\newcommand*{\CIAHvalue}{0.56}
\newcommand*{\CIALvalue}{0.22}
\newcommand*{\CIANvalue}{0.00}
\newcommand{\parseCIA}[1]{%
  \ifnum\pdfstrcmp{#1}{H}=0
	\CIAHvalue%
  \else\ifnum\pdfstrcmp{#1}{L}=0
    \CIALvalue%
  \else\ifnum\pdfstrcmp{#1}{N}=0
    \CIANvalue%
  \else
    unknownCIA%
  \fi\fi\fi%
}

\newcommand{\calcIscBase}[3]{%
	% #1 = ConfidentialityVALUE
	% #2 = IntegrityVALUE
	% #3 = AvailabilityVALUE
	% ISCBase = 1 - [(1−ImpactConf) × (1−ImpactInteg) × (1−ImpactAvail)]
	\FPeval{tempResult}{ 1 - ( (1 - #1) * (1 - #2) * (1 - #3) ) }%
	\tempResult%
}

\newcommand{\calcAndParseIscBase}[3]{
	%1 Confidentiality Impact %High H, Low L, None N
	%2 Integrity Impact %High H, Low L, None N
	%3 Availability Impact %High H, Low L, None N
	\calcIscBase{\parseCIA{#1}}{\parseCIA{#2}}{\parseCIA{#3}}
}%

\newcommand{\calcIsc}[2]{%
	% #1 = Scope
	% #2 = ICSbase
	% Scope Unchanged 6.42 × ISCBase
	% Scope Changed 7.52 × [ISCBase−0.029] − 3.25 × [ISCBase−0.02]15
  \ifnum\pdfstrcmp{#1}{U}=0
	\calcIscScopeUnchanged{#2}%
  \else\ifnum\pdfstrcmp{#1}{C}=0
    \calcIscScopeChanged{#2}%
  \else
    InvalidPrivilegesRequired%
  \fi\fi%
}

\newcommand{\calcIscScopeUnchanged}[1]{%
	% #1 = ICSbase
	% Scope Unchanged 6.42 × ISCBase
	\FPeval{tempResult}{ 6.42 * #1 }%
	\tempResult%
}%

\newcommand{\calcIscScopeChanged}[1]{%
	% #1 = ICSbase
	% Scope Changed 7.52 × [ISCBase−0.029] − 3.25 × [ISCBase−0.02]15
	\FPeval{tempResult}{ 7.52 * ( #1 - 0.029 ) - 3.25 * ( #1 - 0.02 )^15 }%
	\tempResult%
}%

\newcommand{\calcExploitability}[4]{%
	%1 Attack Vector
	%2 Attack Complexity
	%3 Privileges Required
	%4 User Interaction
	% 8.22 × AttackVector × AttackComplexity × PrivilegeRequired × UserInteraction
	\FPeval{tempResult}{ 8.22 * #1 * #2 * #3 * #4 }%
	\tempResult%
}%

\newcommand{\calcAndParseExploitability}[5]{%
	%1 Attack Vector
	%2 Attack Complexity
	%3 Privileges Required
	%4 User Interaction
	%5 Scope
	\calcExploitability%
						{\parseAttackVector{#1}}%
						{\parseAttackComplexity{#2}}%
						{\parsePrivilegesRequired{#3}{#5}}%
						{\parseUserInteraction{#4}}%
}

\newcommand{\cvss}[8]{%
	%1 Attack Vector %Network N, Adjacent A, Local L, Physical P
	%2 Attack Complexity %Low L, High H
	%3 Privileges Required %None N, Low L, High H
	%4 User Interaction %None N, Required R
	%5 Scope %Unchanged U, Changed C
	%6 Confidentiality Impact %High H, Low L, None N
	%7 Integrity Impact %High H, Low L, None N
	%8 Availability Impact %High H, Low L, None N
	
	%\dumpSettings{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}

	%{\calcIsc}[2]{%
	% #1 = Scope
	% #2 = ICSbase

	%\calcAndParseIscBase}[3]{
	%1 Confidentiality Impact
	%2 Integrity Impact
	%3 Availability Impact

	%\calcAndParseExploitability}[5]{%
	%1 Attack Vector
	%2 Attack Complexity
	%3 Privileges Required
	%4 User Interaction
	%5 Scope

	%If (Impact sub score =< 0) 0 else,
	\ifnum\checkSmallerOrEqualsZero{100}=1
		0%
	\else
		\ifnum\pdfstrcmp{#5}{U}=0
			\calculateCVSSScopeUnchanged{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}
		\else\ifnum\pdfstrcmp{#5}{C}=0
			\calculateCVSSScopeChanged{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}
		\else
			InvalidPrivilegesRequired%
		\fi\fi%
	\fi

}

\newcommand{\calculateCVSSScopeUnchanged}[8]{%
	%Scope Unchanged[4] Round up (Minimum [(Impact + Exploitability),10])
	22
}

\newcommand{\calculateCVSSScopeChanged}[8]{%
	%Scope Changed Round up (Minumum [1.08 × (Impact + Exploitability),10])
	33
}

\newcommand\checkSmallerOrEqualsZero[1]
{%
    \ifdim#1pt=0pt
        1
    \else%
        \ifdim#1pt<0pt
        	1
        \else%
        	0
        \fi%
    \fi%
}

\newcommand{\parse}[8]{
	\parseAttackVector{#1}%
	\parseAttackComplexity{#2}%
	\parsePrivilegesRequired{#3}{#5}%
	\parseUserInteraction{#4}%
	\parseCIA{#6}%
	\parseCIA{#7}%
	\parseCIA{#8}%
}

\newcommand{\test}{%
	\noindent
	\testParsing
	\testCalculations
}

\newcommand{\testCalculations}{%
	\noindent

	Should be 0.875:
	\calcIscBase{0.5}{0.5}{0.5} \\%

	Should be 0.6568:
	\calcAndParseIscBase{N}{L}{H} \\%

	Should be 64.2:
	\calcIsc{U}{10} \\%

	Should be 4.9015704164:
	\calcIsc{C}{1} \\%

	Should be 0.51375:
	\calcExploitability{0.5}{0.5}{0.5}{0.5} \\%

	Should be 2.83525473:
	\calcAndParseExploitability{N}{L}{L}{N}{U} \\%

	Should be 3.10963422:
	\calcAndParseExploitability{N}{L}{L}{N}{C} \\%
}

\newcommand{\testParsing}{%
	\parseAttackVector{N} \\%
	\parseAttackVector{A} \\%
	\parseAttackVector{L} \\%
	\parseAttackVector{P} \\%
	\parseAttackComplexity{L} \\%
	\parseAttackComplexity{H} \\%
	\parsePrivilegesRequired{N}{U} \\%
	\parsePrivilegesRequired{L}{U} \\%
	\parsePrivilegesRequired{H}{U} \\%
	\parsePrivilegesRequired{N}{C} \\%
	\parsePrivilegesRequired{L}{C} \\%
	\parsePrivilegesRequired{H}{C} \\%
	\parseUserInteraction{N} \\%
	\parseUserInteraction{R} \\%
	\parseCIA{H} \\%
	\parseCIA{L} \\%
	\parseCIA{N} \\%
}

\newcommand{\dumpSettings}[8]{%
	\noindent
	Attack Vector: #1\\
	Attack Complexity: #2\\
	Privileges Required: #3\\
	User Interaction: #4\\
	Scope: #5\\
	Confidentiality Impact: #6\\
	Integrity Impact: #7\\
	Availability Impact: #8\\
}